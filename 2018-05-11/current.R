library(rvest)
library(dplyr)
# library(meetupr)

# read the page where the list of chapters is located
page <- read_html("https://github.com/rladies/starter-kit/blob/master/Current-Chapters.md")


## Get the cities of the chapters
cities <- page %>%
  html_nodes("#readme strong") %>% 
  html_text() %>% 
  tbl_df()

cities_plus_dc <- page %>%
  html_nodes("h3:nth-child(150) , #readme strong") %>% 
  html_text() 
n_cities <- length(cities_plus_dc)

# get the countries of the chapters ----------------------------
countries <- page %>% 
  html_nodes("ul+ h2 , p+ h2") %>% 
  html_text()
n_countries <- length(countries)



has_meetup_page <- page %>% 
  html_nodes("#readme li:nth-child(1) a") %>% 
  html_text()


rladies_urlname <- sub("/", replacement = "", 
                       sub("https://www.meetup.com/|http://www.meetup.com/", 
                           replacement = "", has_meetup_page))



# Compare what we have on the meetup page with what we have on the current_chapters.md
rladies_groups$urlname[!(rladies_groups$urlname %in% rladies_urlname)]





# meetup numbers
# api_key <- readRDS("../../../meetup_api_key.RDS")
# doc.raw <- RCurl::getURL("https://raw.githubusercontent.com/rladies/starter-kit/master/Current-Chapters.md")
# meetups <- stringr::str_match_all(doc.raw, "www.meetup.com/(.*?)/")[[1]][,2]
# meetups <- unique(meetups)
# 
# n_members <- sapply(meetups, function(x) meetupr::get_members(x, api_key = api_key))


# meetup groups
api_key <- Sys.getenv("MEETUP_KEY")
rladies_groups <- get_groups(text = "r-ladies", api_key = api_key)

# Cleanup
rladies_groups <- rladies_groups[grep(pattern = "ladies", 
                                      x = rladies_groups$urlname,
                                      ignore.case = TRUE), ]
rladies_groups <- rladies_groups[grep(pattern = "r", 
                                      x = rladies_groups$urlname,
                                      ignore.case = TRUE), ]
rladies_groups <- rladies_groups[-grep(pattern = "gentlemen",
                                       x = rladies_groups$urlname,
                                       ignore.case = TRUE), ]
rladies_groups <- rladies_groups[-grep(pattern = "night",
                                       x = rladies_groups$urlname,
                                       ignore.case = TRUE), ]
